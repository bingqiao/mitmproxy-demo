# WTTR with regular proxy
This time a regular proxy will run "behind" wttr so all outgoing requests will be proxied.
## WTTR
This simple golang app now is proxy-aware with this change below in code:
```
client := &http.Client{
  Transport: &http.Transport{
    Proxy: http.ProxyFromEnvironment,
  },
}
```
If environment variables `http_proxy` and `https_proxy` are set, the app will use their values to set up proxy for http client.
## Docker
The most important changes to `docker-compose.yaml` include:
1. adding a `mitmproxy` container
2. setting two environment valriables `http_proxy` and `https_proxy` on `wttr` container, and
3. adding a shared volume so `wttr` container has in the right location the certificate generated by `mitmproxy` upon startup.

Run the app:
```
docker-compose up
```
Notice there is a folder named `mitmproxy` created under `1-mitmproxy-regular`. This folder is volume mounted to mitmproxy container and is used by mitmproxy to store generated certificates.

## Tests
Test 1, request to `wttr.in` (this is the external site) without proxy, success expected:
```
curl "https://wttr.in/Reading?0"
```
Open the web UI for `mitmproxy` in browser at `http://localhost:9081`.

Test 2, request to `wttr.in` (this is the external site) with proxy, failure expected:
```
curl "https://wttr.in/Reading?0" --proxy localhost:9080
```
You likely saw this error message: `unable to get local issuer certificate`, which occured because the certificate issued by `mitmproxy` is not verified by curl. Run the following and expect success:
```
curl "https://wttr.in/Reading?0" --proxy localhost:9080 --cacert ./mitmproxy/mitmproxy-ca-cert.pem
```
Observe this request shows up in mitmproxy web UI.
Test 3, request to `localhost:8080`, success expected:
``
curl "http://localhost:8080/?loc=Reading"
``
N.B. the protocol is `http`, instead of `https` and a query param `loc` is used to send location.

Observe another request to `wttr.in` shows up in mitmproxy web UI.

Ctrl+C to stop the docker compose. Then do the clean up:
```
docker-compose down
```

# Kubernetes
If you haven't run `docker-compose up`, run the following to build the docker image first:
```
docker buildx build -t wttr-proxied .
```
The docker image needs to be made availabe to the Kubernetes cluster. For a local Kind cluster, this is done by:
```
kind load docker-image wttr-proxied:latest --name k8s-dev
```
You can check if the image has been loaded correctly by:
```
docker exec -it k8s-dev-control-plane crictl images
```
Deploy `wttr-proxied` app and `mitmproxy` to local cluster `k8s-dev`:
```
kubectl apply -f deployment.yaml
```
Check the new pod is up and running without error:
```
kubectl get pods
```
Open up another terminal and set up port-forward so the wttr cluster service `wttr-service-proxied` just deployed can be accessed at port 8080 (mapped to wttr container) from local host:
```
kubectl port-forward service/wttr-service-proxied 8080:8080
```
Open up another terminal and set up port-forward so the wttr cluster service `wttr-service-proxied` just deployed can be accessed at port 9080 (mapped to mitmproxy container for proxy) from local host:
```
kubectl port-forward service/wttr-service-proxied 9080:9080
```
Open up another terminal and set up port-forward so the wttr cluster service `wttr-service-proxied` just deployed can be accessed at prot 9081 (mapped to mitmproxy container for proxy web UI) from local host:
```
kubectl port-forward service/wttr-service-proxied 9081:9081
```
## Tests
Test 1, request to `wttr.in` (this is the external site) without proxy, success expected:
```
curl "https://wttr.in/Reading?0"
```
Open the web UI for `mitmproxy` in browser at `http://localhost:9081`.

Test 2, request to `wttr.in` (this is the external site) with proxy, failure expected:
```
curl "https://wttr.in/Reading?0" --proxy localhost:9080
```
You likely saw this error message: `unable to get local issuer certificate`, which occured because the certificate issued by `mitmproxy` is not verified by curl.
Copy the generated certificate from inside `mitmproxy` container:
```
kubectl cp -c mitmproxy wttr-proxied:root/.mitmproxy/mitmproxy-ca-cert.pem ./mitmproxy-ca-cert.pem
```
Run the following and expect success:
```
curl "https://wttr.in/Reading?0" --proxy localhost:9080 --cacert ./mitmproxy-ca-cert.pem
```
Observe this request shows up in mitmproxy web UI.
Test 3, request to `localhost:8080`, success expected:
``
curl "http://localhost:8080/?loc=Reading"
``
N.B. the protocol is `http`, instead of `https` and a query param `loc` is used to send location.

Observe another request to `wttr.in` shows up in mitmproxy web UI.

Ctrl+C to stop the all three port-forward termnimal then run the following to cleanup:
```
kubectl delete -f deployment.yaml
```

This concludes the third part of this tutorial.